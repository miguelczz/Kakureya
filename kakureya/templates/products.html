{% extends 'base.html' %}
{% load group_filters %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/products.css' %}" />

<main class="container py-4">
    <h1 class="text-center display-3 pb-4">Productos</h1>

    <div class="row g-4">
        {% for product in products %}
        <div class="col-12 col-md-6">
            <!-- Card de Producto -->
            <div class="card shadow-sm h-100 d-flex flex-row align-items-center p-3" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#productModal{{ product.id }}">
                
                <div class="flex-grow-1 pe-2">
                    <h5 class="card-title fw-bold mb-1">{{ product.name }}</h5>
                    <p class="card-text small text-muted mb-1">{{ product.description|truncatewords:12 }}</p>
                    <p class="card-text fw-bold text-success mb-0">$ {{ product.price|floatformat:0 }}</p>
                </div>

                <div style="width: 100px; height: 100px;">
                    {% if product.image %}
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="img-fluid rounded" style="object-fit: cover; width: 100%; height: 100%;">
                    {% else %}
                        <img src="{% static 'images/default_product.jpg' %}" alt="Sin imagen" class="img-fluid rounded" style="object-fit: cover; width: 100%; height: 100%;">
                    {% endif %}
                </div>

            </div>
        </div>

        <!-- Modal de Producto -->
        <div class="modal fade" id="productModal{{ product.id }}" tabindex="-1" aria-labelledby="productModalLabel{{ product.id }}" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold" id="productModalLabel{{ product.id }}">{{ product.name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body d-flex flex-column flex-md-row align-items-center">
                        <div class="col-md-6 text-center mb-3 mb-md-0">
                            {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="img-fluid" style="max-height: 300px;">
                            {% endif %}
                        </div>
                        <div class="col-md-6 ps-md-4 text-center text-md-start">
                            <h5 class="fw-bold text-success mb-3">$ {{ product.price|floatformat:0 }}</h5>
                            <p>{{ product.description }}</p>

                            {% if user|in_group:"Administrador" %}
                                <!-- Botones para administrador -->
                                <div class="d-flex justify-content-center justify-content-md-start mt-4 flex-wrap">
                                    <a href="{% url 'product_detail' product.id %}" class="btn btn-outline-primary me-2 mb-2">Editar Producto</a>
                                    <form action="{% url 'delete_product' product.id %}" method="POST">
                                        {% csrf_token %}
                                        <button class="btn btn-danger">Eliminar</button>
                                    </form>
                                </div>
                            {% else %}
                                <form action="{% url 'add_to_cart' product.id %}" method="POST" class="d-flex justify-content-center justify-content-md-start align-items-center mt-4 flex-wrap">
                                    {% csrf_token %}
                                    {% if categoria_seleccionada %}
                                        <input type="hidden" name="categoria" value="{{ categoria_seleccionada }}">
                                    {% endif %}
                                    <button type="button" class="btn btn-outline-secondary" onclick="decreaseQuantity(this)">-</button>
                                    <input type="number" name="quantity" id="quantity{{ product.id }}" value="1" min="1" class="form-control mx-2 my-2" style="width: 70px;">
                                    <button type="button" class="btn btn-outline-secondary" onclick="increaseQuantity(this)">+</button>
                    
                                    <button type="submit" class="btn btn-success ms-md-3 mt-2 mt-md-0">Agregar</button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% endfor %}
    </div>
</main>

<script>
function increaseQuantity(productId) {
    const qtyInput = document.getElementById('quantity' + productId);
    qtyInput.value = parseInt(qtyInput.value) + 1;
}

function decreaseQuantity(productId) {
    const qtyInput = document.getElementById('quantity' + productId);
    if (parseInt(qtyInput.value) > 1) {
        qtyInput.value = parseInt(qtyInput.value) - 1;
    }
}
</script>

{% endblock %}
