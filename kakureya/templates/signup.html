{% extends 'base.html' %}

{% block content %}
<main class="container d-flex justify-content-center align-items-center py-5">
  <div class="card shadow-lg p-4" style="max-width: 800px; width: 100%;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="fw-bold mb-0">Crear Cuenta</h2>
      <button type="button" class="btn btn-sm btn-outline-dark" data-bs-toggle="modal" data-bs-target="#instructionsModal">
        <i class="ri-information-line me-1"></i> Instrucciones
      </button>
    </div>
    
    <p class="text-muted small mb-4">Los campos marcados con <span class="text-danger">*</span> son obligatorios</p>

    <!-- Div para mostrar errores desde AJAX -->
    <div id="form-errors"></div>

    <form method="POST" action="{% url 'signup' %}">
      {% csrf_token %}
      {{ form.non_field_errors }}

      <div class="row">
        <!-- Primer nombre -->
        <div class="col-md-6 mb-3">
          <label for="first_name" class="form-label fw-semibold">
            Primer nombre <span class="text-danger">*</span>
          </label>
          <div class="text-danger small">{{ form.first_name.errors }}</div>
          <input type="text" name="first_name" id="first_name" class="form-control" placeholder="Primer nombre" required>
        </div>

        <!-- Segundo nombre (opcional) -->
        <div class="col-md-6 mb-3">
          <label for="middle_name" class="form-label fw-semibold">
            Segundo nombre <span class="text-muted"></span>
          </label>
          <div class="text-danger small">{{ form.middle_name.errors }}</div>
          <input type="text" name="middle_name" id="middle_name" class="form-control" placeholder="Segundo nombre">
        </div>
      </div>

      <div class="row">
        <!-- Primer apellido -->
        <div class="col-md-6 mb-3">
          <label for="last_name" class="form-label fw-semibold">
            Primer apellido <span class="text-danger">*</span>
          </label>
          <div class="text-danger small">{{ form.last_name.errors }}</div>
          <input type="text" name="last_name" id="last_name" class="form-control" placeholder="Primer apellido" required>
        </div>

        <!-- Segundo apellido (ahora obligatorio) -->
        <div class="col-md-6 mb-3">
          <label for="second_last_name" class="form-label fw-semibold">
            Segundo apellido <span class="text-danger">*</span>
          </label>
          <div class="text-danger small">{{ form.second_last_name.errors }}</div>
          <input type="text" name="second_last_name" id="second_last_name" class="form-control" placeholder="Segundo apellido" required>
        </div>
      </div>

      <div class="row">
        <!-- DNI -->
        <div class="col-md-6 mb-3">
          <label for="dni" class="form-label fw-semibold">
            Documento de identidad <span class="text-danger">*</span>
          </label>
          <div class="text-danger small">{{ form.dni.errors }}</div>
          <input type="text" name="dni" id="dni" class="form-control" placeholder="Número de documento" required>
        </div>

        <!-- Email -->
        <div class="col-md-6 mb-3">
          <label for="email" class="form-label fw-semibold">
            Correo electrónico <span class="text-danger">*</span>
          </label>
          <div class="text-danger small">{{ form.email.errors }}</div>
          <input type="email" name="email" id="email" class="form-control" placeholder="Correo electrónico" required>
        </div>
      </div>
      
      <!-- Dirección -->
      <div class="mb-3">
        <label for="address" class="form-label fw-semibold">
          Dirección <span class="text-danger">*</span>
        </label>
        <div class="text-danger small">{{ form.address.errors }}</div>
        <textarea name="address" id="address" class="form-control" rows="3" placeholder="Dirección completa" required></textarea>
      </div>

      <!-- Teléfono -->
      <div class="mb-3">
        <label for="phone_number" class="form-label fw-semibold">
          Número de teléfono <span class="text-muted"></span>
        </label>
        <div class="text-danger small">{{ form.phone_number.errors }}</div>
        <input type="text" name="phone_number" id="phone_number" class="form-control" placeholder="Número de teléfono">
      </div>

      <!-- Contraseña -->
      <div class="mb-3">
        <label for="password1" class="form-label fw-semibold">
          Contraseña <span class="text-danger">*</span>
        </label>
        <div class="text-danger small">{{ form.password1.errors }}</div>
        <input type="password" name="password1" id="password1" class="form-control" placeholder="Contraseña" required>
      </div>

      <!-- Confirmar Contraseña -->
      <div class="mb-4">
        <label for="password2" class="form-label fw-semibold">
          Confirmar contraseña <span class="text-danger">*</span>
        </label>
        <div class="text-danger small">{{ form.password2.errors }}</div>
        <input type="password" name="password2" id="password2" class="form-control" placeholder="Confirmar contraseña" required>
      </div>

      <!-- Botón enviar -->
      <div class="d-grid">
        <button class="btn btn-dark fw-semibold">Registrarse</button>
      </div>

      <p class="text-center mt-3 mb-0 small">
        ¿Ya tienes una cuenta?
        <a href="{% url 'signin' %}" class="text-decoration-none">Inicia sesión</a>
      </p>
    </form>
  </div>
</main>

<!-- Modal de instrucciones -->
<div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title text-white" id="instructionsModalLabel">Instrucciones para el registro</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-4">
          <h6 class="fw-bold">Información personal</h6>
          <p>Para crear tu cuenta en Kakureya, necesitamos los siguientes datos personales:</p>
          <ul>
            <li><strong class="text-dark">Nombre completo:</strong> Tu primer nombre y primer apellido son obligatorios. El segundo nombre es opcional, pero el segundo apellido es obligatorio.</li>
            <li><strong class="text-dark">Documento de identidad (DNI):</strong> Ingresa tu número de identificación sin puntos ni espacios.</li>
            <li><strong class="text-dark">Correo electrónico:</strong> Asegúrate de proporcionar un correo electrónico válido, ya que será tu método principal para iniciar sesión.</li>
          </ul>
        </div>
        
        <div class="mb-4">
          <h6 class="fw-bold">Dirección y contacto</h6>
          <p>Necesitamos tu dirección para poder enviarte los pedidos:</p>
          <ul>
            <li><strong class="text-dark">Dirección completa:</strong> Incluye calle, número, apartamento, barrio y referencias de ser necesario.</li>
            <li><strong class="text-dark">Teléfono:</strong> Aunque es opcional, te recomendamos proporcionarlo para contactarte en caso de incidencias con tu pedido.</li>
          </ul>
        </div>
        
        <div class="mb-4">
          <h6 class="fw-bold">Contraseña</h6>
          <p>Para mayor seguridad, tu contraseña debe cumplir con los siguientes requisitos:</p>
          <ul>
            <li>Mínimo 8 caracteres</li>
            <li>No puede ser similar a tu información personal</li>
            <li>No puede ser una contraseña común (como "123456")</li>
            <li>No puede consistir únicamente en números</li>
          </ul>
        </div>
        
        <div class="alert alert-info mb-0">
          <p class="mb-0">Para cualquier duda o problema con el registro, puedes contactar con nuestro soporte técnico en <span class="text-primary">kakureyagroup@gmail.com</span></p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Script para el manejo del envío del formulario via AJAX -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form');
  const errorContainer = document.getElementById('form-errors');

  form.addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(form);
    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.href = data.redirect;
      } else {
        // Mostrar errores
        errorContainer.innerHTML = '<div class="alert alert-danger"><ul class="mb-0">';
        data.errors.forEach(error => {
          errorContainer.innerHTML += `<li>${error}</li>`;
        });
        errorContainer.innerHTML += '</ul></div>';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      errorContainer.innerHTML = `
        <div class="alert alert-danger">Error inesperado al procesar la solicitud.</div>
      `;
    });
  });
});
</script>
{% endblock %}